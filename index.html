<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tasktify - Your Customizable To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: var(--font-family);
            background: var(--primary-bg); /* Use CSS variable for primary background */
            transition: background 0.5s ease; /* Smooth transition for background gradient */
        }

        /* Define CSS Variables on the root element */
        :root {
            /* Colors */
            --primary-bg: linear-gradient(to right, #8b5cf6, #4f46e5); /* purple-500 to indigo-600 */
            --secondary-bg: #ffffff; /* white */
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #6b7280; /* gray-500 */
            --header-text: #4338ca; /* indigo-700 */
            --input-border: #d1d5db; /* gray-300 */
            --input-focus-ring: #a5b4fc; /* indigo-300 */
            --button-primary-bg: #4f46e5; /* indigo-600 */
            --button-primary-hover-bg: #4338ca; /* indigo-700 */
            --task-item-bg: #ffffff; /* white */
            --task-item-border: #e5e7eb; /* gray-200 */
            --task-text-done: #9ca3af; /* gray-400 */ /* For line-through */
            --timestamp-text: #9ca3af; /* gray-400 */
            --button-done-bg: #22c55e; /* green-500 */
            --button-done-hover-bg: #16a34a; /* green-600 */
            --button-undone-bg: #f59e0b; /* yellow-500 */
            --button-undone-hover-bg: #d97706; /* yellow-600 */
            --button-edit-bg: #3b82f6; /* blue-500 */
            --button-edit-hover-bg: #2563eb; /* blue-600 */
            --button-delete-bg: #ef4444; /* red-500 */
            --button-delete-hover-bg: #dc2626; /* red-600 */
            --button-save-bg: #2563eb;
            --button-save-hover-bg: #1d4ed8;
            --button-cancel-bg: #9ca3af;
            --button-cancel-hover-bg: #6b7280;
            --error-text-color: #ef4444;
            --google-button-bg: #db4437;
            --google-button-hover-bg: #c13122;
        }

        /* Apply variables to Tailwind classes */
        .main-container {
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius-main);
            box-shadow: var(--shadow-main);
            color: var(--text-primary);
            transition: background-color 0.5s ease, border-radius 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease; /* Ensure transition for hover */
        }
        .header-text {
            color: var(--header-text);
        }
        .input-field {
            border-color: var(--input-border);
            color: var(--text-primary);
            background-color: var(--secondary-bg);
        }
        .input-field::placeholder {
            color: var(--text-secondary);
        }
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 4px var(--input-focus-ring);
        }
        .button-primary {
            background-color: var(--button-primary-bg);
            color: white;
        }
        .button-primary:hover {
            background-color: var(--button-primary-hover-bg);
        }
        .button-google {
            background-color: var(--google-button-bg);
            color: white;
        }
        .button-google:hover {
            background-color: var(--google-button-hover-bg);
        }
        .task-item {
            background-color: var(--task-item-bg);
            border-color: var(--task-item-border);
            box-shadow: var(--shadow-item);
            border-radius: var(--border-radius-elements);
        }
        .task-text {
            color: var(--text-primary);
        }
        .task-text.line-through {
            color: var(--task-text-done);
        }
        .timestamp-text {
            color: var(--timestamp-text);
        }
        .button-done {
            background-color: var(--button-done-bg);
            color: white;
        }
        .button-done:hover {
            background-color: var(--button-done-hover-bg);
        }
        .button-undone {
            background-color: var(--button-undone-bg);
            color: white;
        }
        .button-undone:hover {
            background-color: var(--button-undone-hover-bg);
        }
        .button-edit {
            background-color: var(--button-edit-bg);
            color: white;
        }
        .button-edit:hover {
            background-color: var(--button-edit-hover-bg);
        }
        .button-delete {
            background-color: var(--button-delete-bg);
            color: white;
        }
        .button-delete:hover {
            background-color: var(--button-delete-hover-bg);
        }
        .button-save {
            background-color: var(--button-save-bg);
            color: white;
        }
        .button-save:hover {
            background-color: var(--button-save-hover-bg);
        }
        .button-cancel {
            background-color: var(--button-cancel-bg);
            color: white;
        }
        .button-cancel:hover {
            background-color: var(--button-cancel-hover-bg);
        }
        .theme-selector-wrapper .theme-selector {
            background-color: var(--task-item-bg);
            color: var(--text-primary);
        }
        .theme-selector-wrapper .theme-selector:focus {
              outline: none;
            box-shadow: 0 0 0 2px var(--input-focus-ring);
        }
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .header-content h1 {
            text-align: center;
            max-width: fit-content;
            margin-left: 0;
            margin-right: 0;
        }
        .header-content > .flex.items-center.justify-between.w-full {
            margin-top: 0.5rem;
        }

        .auth-error {
            color: var(--error-text-color);
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
        .user-info {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            font-size: 0.875rem;
            color: var(--text-primary);
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius-elements);
            box-shadow: var(--shadow-item);
            margin-bottom: 1rem;
        }
        .user-info button {
            background-color: var(--button-cancel-bg);
            color: white;
            padding: 4px 8px;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .user-info button:hover {
            background-color: var(--button-cancel-hover-bg);
        }
        .button-google img {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }

        /* NEW CSS FOR SMOOTH TRANSITIONS */
        .fade-section {
            opacity: 0;
            transform: scale(0.95) translateY(10px); /* Slightly scale down and move up initially */
            transition: opacity 0.6s ease-out, transform 0.6s ease-out; /* Longer, smoother transition */
        }
        .fade-section.active {
            opacity: 1;
            transform: scale(1) translateY(0); /* Return to original size and position */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6">

    <div class="w-full max-w-lg main-container rounded-2xl shadow-xl p-8 transform transition-all duration-300 hover:scale-105 relative fade-section active">
        <div class="header-content flex flex-col items-center mb-6 relative">
            <div id="user-display" class="user-info w-full flex justify-between items-center mb-4 hidden">
                <span id="user-email" class="text-sm font-medium"></span>
                <button id="logout-button" class="px-3 py-1 text-xs rounded-md transition button-cancel hover:button-cancel-hover">Logout</button>
            </div>
            
            <div class="flex items-center justify-between w-full">
                <h1 class="text-4xl font-extrabold header-text tracking-tight flex-grow text-center">Tasktify</h1>
                <div class="flex items-center gap-2 theme-selector-wrapper">
                    <label for="theme-selector" class="text-sm theme-selector-label" style="color: var(--text-primary);">Theme:</label>
                    <select id="theme-selector" class="p-2 rounded-md theme-selector focus:ring-2 focus:ring-indigo-400">
                        <option value="default">Default (Light)</option>
                        <option value="dark">Dark Mode</option>
                        <option value="ocean">Ocean Blue</option>
                        <option value="forest">Forest Green</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="auth-section" class="mb-6 fade-section active">
            <h2 class="text-2xl font-semibold mb-4 text-center header-text">Welcome!</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium" style="color: var(--text-primary);">Email</label>
                    <input type="email" id="login-email" required class="input-field mt-1 block w-full px-4 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium" style="color: var(--text-primary);">Password</label>
                    <input type="password" id="login-password" required class="input-field mt-1 block w-full px-4 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="button-primary w-full px-4 py-2 rounded-md transition duration-300 ease-in-out">
                    Login
                </button>
                <p id="login-error" class="auth-error text-center"></p>
                <p class="text-center my-4" style="color: var(--text-secondary);">OR</p>
                <button type="button" id="google-login-button" class="button-google w-full px-4 py-2 rounded-md transition duration-300 ease-in-out flex items-center justify-center">
                    <img src="https://img.icons8.com/color/48/000000/google-logo.png" alt="Google Logo" />
                    Login with Google
                </button>
                <p class="text-center text-sm mt-4" style="color: var(--text-secondary);">
                    Don't have an account? <a href="#" id="show-signup" class="text-indigo-600 hover:text-indigo-800 font-medium">Sign Up</a>
                </p>
            </form>

            <form id="signup-form" class="space-y-4 hidden">
                <div>
                    <label for="signup-email" class="block text-sm font-medium" style="color: var(--text-primary);">Email</label>
                    <input type="email" id="signup-email" required class="input-field mt-1 block w-full px-4 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium" style="color: var(--text-primary);">Password</label>
                    <input type="password" id="signup-password" required class="input-field mt-1 block w-full px-4 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="button-primary w-full px-4 py-2 rounded-md transition duration-300 ease-in-out">
                    Sign Up
                </button>
                <p id="signup-error" class="auth-error text-center"></p>
                <p class="text-center my-4" style="color: var(--text-secondary);">OR</p>
                <button type="button" id="google-signup-button" class="button-google w-full px-4 py-2 rounded-md transition duration-300 ease-in-out flex items-center justify-center">
                    <img src="https://img.icons8.com/color/48/000000/google-logo.png" alt="Google Logo" />
                    Sign Up with Google
                </button>
                <p class="text-center text-sm mt-4" style="color: var(--text-secondary);">
                    Already have an account? <a href="#" id="show-login" class="text-indigo-600 hover:text-indigo-800 font-medium">Login</a>
                </p>
            </form>
        </div>

        <div id="task-section" class="hidden fade-section">
            <form class="new-task-form flex gap-3 mb-6">
                <input
                    type="text"
                    required
                    class="new-task flex-1 px-5 py-3 border rounded-xl text-lg placeholder-gray-400 input-field"
                    placeholder="What's your next task?" />
                <button
                    type="submit"
                    class="button-primary px-6 py-3 rounded-xl hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg text-lg">
                    Add Task
                </button>
            </form>
            <ol id="Task" class="space-y-4"></ol>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Firebase Configuration
            // IMPORTANT: Replace with your actual Firebase project configuration!
            const firebaseConfig = {
                apiKey: "AIzaSyDONsCD2ylgOMLz2gmZ0dEz2C4IdeF0wKA", // REPLACE THIS LINE WITH YOUR ACTUAL API KEY
                authDomain: "tasktify-1cb16.firebaseapp.com", // REPLACE THIS LINE WITH YOUR ACTUAL AUTH DOMAIN
                projectId: "tasktify-1cb16", // REPLACE THIS LINE WITH YOUR ACTUAL PROJECT ID
                storageBucket: "tasktify-1cb16.appspot.com", // REPLACE THIS LINE WITH YOUR ACTUAL STORAGE BUCKET
                messagingSenderId: "759089908374", // REPLACE THIS LINE WITH YOUR ACTUAL MESSAGING SENDER ID
                appId: "1:759089908374:web:cf8a405e6ceb129b6090b7", // REPLACE THIS LINE WITH YOUR ACTUAL APP ID
                measurementId: "G-50NJYVKLB7" // REPLACE THIS LINE WITH YOUR ACTUAL MEASUREMENT ID (OR REMOVE IF NOT APPLICABLE)
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            const googleProvider = new firebase.auth.GoogleAuthProvider(); // Initialize Google Auth Provider

            let currentUser = null; // To store the current authenticated user

            // --- Theme Switching Logic ---
            const themeSelector = $('#theme-selector');
            const root = document.documentElement; // Get the :root element

            const themes = {
                'default': { // Light Theme (similar to current)
                    '--primary-bg': 'linear-gradient(to right, #8b5cf6, #4f46e5)',
                    '--secondary-bg': '#ffffff',
                    '--text-primary': '#1f2937',
                    '--text-secondary': '#6b7280',
                    '--header-text': '#4338ca',
                    '--input-border': '#d1d5db',
                    '--input-focus-ring': '#a5b4fc',
                    '--button-primary-bg': '#4f46e5',
                    '--button-primary-hover-bg': '#4338ca',
                    '--task-item-bg': '#ffffff',
                    '--task-item-border': '#e5e7eb',
                    '--task-text-done': '#9ca3af',
                    '--timestamp-text': '#9ca3af',
                    '--button-done-bg': '#22c55e',
                    '--button-done-hover-bg': '#16a34a',
                    '--button-undone-bg': '#f59e0b',
                    '--button-undone-hover-bg': '#d97706',
                    '--button-edit-bg': '#3b82f6',
                    '--button-edit-hover-bg': '#2563eb',
                    '--button-delete-bg': '#ef4444',
                    '--button-delete-hover-bg': '#dc2626',
                    '--button-save-bg': '#2563eb',
                    '--button-save-hover-bg': '#1d4ed8',
                    '--button-cancel-bg': '#9ca3af',
                    '--button-cancel-hover-bg': '#6b7280',
                    '--error-text-color': '#ef4444',
                    '--google-button-bg': '#db4437',
                    '--google-button-hover-bg': '#c13122',
                },
                'dark': {
                    '--primary-bg': '#1a202c', /* charcoal */
                    '--secondary-bg': '#2d3748', /* darker gray */
                    '--text-primary': '#e2e8f0', /* light gray */
                    '--text-secondary': '#a0aec0', /* lighter gray */
                    '--header-text': '#9f7aea', /* lighter purple */
                    '--input-border': '#4a5568',
                    '--input-focus-ring': '#6b46c1', /* darker purple */
                    '--button-primary-bg': '#6b46c1',
                    '--button-primary-hover-bg': '#553c9a',
                    '--task-item-bg': '#2d3748',
                    '--task-item-border': '#4a5568',
                    '--task-text-done': '#a0aec0',
                    '--timestamp-text': '#a0aec0',
                    '--button-done-bg': '#38a169', /* darker green */
                    '--button-done-hover-bg': '#2f855a',
                    '--button-undone-bg': '#d69e2e', /* darker yellow */
                    '--button-undone-hover-bg': '#b7791f',
                    '--button-edit-bg': '#4299e1', /* darker blue */
                    '--button-edit-hover-bg': '#3182ce',
                    '--button-delete-bg': '#e53e3e', /* darker red */
                    '--button-delete-hover-bg': '#c53030',
                    '--button-save-bg': '#3182ce',
                    '--button-save-hover-bg': '#2b6cb0',
                    '--button-cancel-bg': '#4a5568',
                    '--button-cancel-hover-bg': '#2d3748',
                    '--error-text-color': '#fc8181', /* Lighter red for dark mode */
                    '--google-button-bg': '#db4437',
                    '--google-button-hover-bg': '#c13122',
                },
                'ocean': {
                    '--primary-bg': 'linear-gradient(to right, #6366f1, #3b82f6)', /* indigo-500 to blue-500 */
                    '--secondary-bg': '#e0f2fe', /* light blue */
                    '--text-primary': '#1e3a8a', /* dark blue */
                    '--text-secondary': '#4a679e',
                    '--header-text': '#1e3a8a',
                    '--input-border': '#93c5fd', /* blue-300 */
                    '--input-focus-ring': '#a5b4fc',
                    '--button-primary-bg': '#2563eb', /* blue-600 */
                    '--button-primary-hover-bg': '#1e40af', /* blue-800 */
                    '--task-item-bg': '#eff6ff', /* lighter blue */
                    '--task-item-border': '#bfdbfe', /* blue-200 */
                    '--task-text-done': '#60a5fa', /* blue-400 */
                    '--timestamp-text': '#60a5fa',
                    '--button-done-bg': '#34d399', /* teal */
                    '--button-done-hover-bg': '#10b981',
                    '--button-undone-bg': '#fbbf24', /* amber */
                    '--button-undone-hover-bg': '#f59e0b',
                    '--button-edit-bg': '#3b82f6',
                    '--button-edit-hover-bg': '#2563eb',
                    '--button-delete-bg': '#ef4444',
                    '--button-delete-hover-bg': '#dc2626',
                    '--button-save-bg': '#2563eb',
                    '--button-save-hover-bg': '#1d4ed8',
                    '--button-cancel-bg': '#93c5fd',
                    '--button-cancel-hover-bg': '#60a5fa',
                    '--error-text-color': '#e0f2fe',
                    '--google-button-bg': '#db4437',
                    '--google-button-hover-bg': '#c13122',
                },
                'forest': {
                    '--primary-bg': 'linear-gradient(to right, #10b981, #059669)', /* emerald-500 to green-600 */
                    '--secondary-bg': '#f0fdf4', /* light green */
                    '--text-primary': '#1f2937', /* dark gray */
                    '--text-secondary': '#4b5563', /* gray */
                    '--header-text': '#047857', /* dark green */
                    '--input-border': '#a7f3d0', /* emerald-200 */
                    '--input-focus-ring': '#6ee7b7', /* emerald-300 */
                    '--button-primary-bg': '#059669', /* green-600 */
                    '--button-primary-hover-bg': '#047857', /* green-700 */
                    '--task-item-bg': '#d1fae5', /* very light green */
                    '--task-item-border': '#6ee7b7', /* emerald-300 */
                    '--task-text-done': '#34d399', /* emerald-500 */
                    '--timestamp-text': '#34d399',
                    '--button-done-bg': '#22c55e',
                    '--button-done-hover-bg': '#16a34a',
                    '--button-undone-bg': '#fbbf24',
                    '--button-undone-hover-bg': '#f59e0b',
                    '--button-edit-bg': '#4ade80', /* lime-400 */
                    '--button-edit-hover-bg': '#22c55e',
                    '--button-delete-bg': '#ef4444',
                    '--button-delete-hover-bg': '#dc2626',
                    '--button-save-bg': '#059669',
                    '--button-save-hover-bg': '#047857',
                    '--button-cancel-bg': '#a7f3d0',
                    '--button-cancel-hover-bg': '#6ee7b7',
                    '--error-text-color': '#f87171',
                    '--google-button-bg': '#db4437',
                    '--google-button-hover-bg': '#c13122',
                }
            };

            function applyTheme(themeName) {
                const selectedTheme = themes[themeName];
                for (const property in selectedTheme) {
                    root.style.setProperty(property, selectedTheme[property]);
                }
                localStorage.setItem('chosenTheme', themeName);
            }

            // Load saved theme or set default on page load
            const savedTheme = localStorage.getItem('chosenTheme');
            if (savedTheme && themes[savedTheme]) {
                applyTheme(savedTheme);
                themeSelector.val(savedTheme); // Set dropdown to current theme
            } else {
                applyTheme('default'); // Fallback to default theme
                themeSelector.val('default');
            }

            // Event listener for theme selector
            themeSelector.on('change', function() {
                applyTheme($(this).val());
            });

            // --- End Theme Switching Logic ---

            // --- Auth Logic (MODIFIED FOR SMOOTH TRANSITIONS) ---
            const authSection = $('#auth-section');
            const taskSection = $('#task-section');
            const loginForm = $('#login-form');
            const signupForm = $('#signup-form');
            const loginError = $('#login-error');
            const signupError = $('#signup-error');
            const showSignup = $('#show-signup');
            const showLogin = $('#show-login');
            const userDisplay = $('#user-display');
            const userEmailSpan = $('#user-email');
            const logoutButton = $('#logout-button');
            const googleLoginButton = $('#google-login-button');
            const googleSignupButton = $('#google-signup-button');
            const newTaskForm = $('.new-task-form'); // Select the new task form

            // Function to transition between sections
            function transitionToSection(showSection, hideSection) {
                // Hide current section visually
                hideSection.removeClass('active');
                
                // Wait for the fade-out transition to complete (0.6s CSS transition)
                setTimeout(() => {
                    hideSection.addClass('hidden'); // Fully hide with display: none
                    showSection.removeClass('hidden'); // Make the target section visible (display: block)

                    // A small delay is crucial here. Without it, the browser might
                    // not register the `display: block` change before `active` is added,
                    // causing the fade-in animation not to trigger.
                    setTimeout(() => {
                        showSection.addClass('active'); // Start the fade-in transition
                    }, 50); // Small delay
                }, 600); // This delay should match your CSS transition duration (0.6s = 600ms)
            }

            // Toggle between login and signup forms (within auth-section)
            showSignup.on('click', function(e) {
                e.preventDefault();
                loginForm.hide();
                signupForm.show();
                loginError.text('');
                signupError.text('');
            });

            showLogin.on('click', function(e) {
                e.preventDefault();
                signupForm.hide();
                loginForm.show();
                loginError.text('');
                signupError.text('');
            });

            // Login Handler (Email/Password)
            loginForm.on('submit', function(e) {
                e.preventDefault();
                const email = $('#login-email').val();
                const password = $('#login-password').val();
                loginError.text('');

                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Signed in - handled by onAuthStateChanged listener
                    })
                    .catch((error) => {
                        const errorMessage = error.message;
                        loginError.text(errorMessage);
                    });
            });

            // Signup Handler (Email/Password)
            signupForm.on('submit', function(e) {
                e.preventDefault();
                const email = $('#signup-email').val();
                const password = $('#signup-password').val();
                signupError.text('');

                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Signed up - handled by onAuthStateChanged listener
                    })
                    .catch((error) => {
                        const errorMessage = error.message;
                        signupError.text(errorMessage);
                    });
            });

            // Google Sign-In Handler
            function handleGoogleSignIn() {
                auth.signInWithPopup(googleProvider)
                    .then((result) => {
                        // Handled by onAuthStateChanged listener
                    }).catch((error) => {
                        const errorMessage = error.message;
                        if (loginForm.is(':visible')) {
                            loginError.text(`Google Sign-in Error: ${errorMessage}`);
                        } else if (signupForm.is(':visible')) {
                            signupError.text(`Google Sign-up Error: ${errorMessage}`);
                        }
                        console.error("Google Sign-in Error:", error);
                    });
            }

            googleLoginButton.on('click', handleGoogleSignIn);
            googleSignupButton.on('click', handleGoogleSignIn);

            // Logout Handler
            logoutButton.on('click', function() {
                auth.signOut().then(() => {
                    // Signed out - handled by onAuthStateChanged listener
                }).catch((error) => {
                    console.error("Logout Error:", error);
                });
            });

            // Firebase Auth State Listener (MODIFIED)
            auth.onAuthStateChanged((user) => {
                currentUser = user; // Update the global currentUser variable
                if (user) {
                    // User is logged in
                    userEmailSpan.text(user.email);
                    userDisplay.removeClass('hidden'); // User info should be visible instantly
                    newTaskForm.removeClass('hidden'); // Show the new task input form

                    $("#Task").empty(); // Clear previous tasks on login
                    setupRealtimeListener(user.uid); // Setup listener for this user's tasks

                    // Trigger the transition from auth-section to task-section
                    transitionToSection(taskSection, authSection);

                } else {
                    // User is logged out
                    userDisplay.addClass('hidden');
                    userEmailSpan.text('');
                    newTaskForm.addClass('hidden'); // Hide the new task input form on logout

                    $("#Task").empty(); // Clear tasks on logout
                    if (taskListener) { // Unsubscribe if a listener exists
                        taskListener();
                        taskListener = null;
                    }
                    // Show login form by default on logout
                    loginForm.show(); // Ensure login form is shown within auth section
                    signupForm.hide();
                    loginError.text('');
                    signupError.text('');

                    // Trigger the transition from task-section back to auth-section
                    transitionToSection(authSection, taskSection);
                }
            });

            // --- End Auth Logic ---

            // --- Firestore Task Logic (Modified for User Specificity) ---
            let taskListener = null; // To store the Firestore listener unsubscribe function

            function setupRealtimeListener(uid) {
                // If a listener already exists, unsubscribe it first
                if (taskListener) {
                    taskListener();
                }

                // Setup new listener for the current user's tasks
                // This is the query that filters by userId and orders by timestamp
                taskListener = db.collection("Task")
                    .where("userId", "==", uid) // Filter by current user's ID
                    .orderBy("timestamp", "desc") // Order by timestamp
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            const data = change.doc.data();
                            const id = change.doc.id;
                            const html = renderTask(id, data.todo, data.done, data.timestamp);

                            if (change.type === "added") {
                                $("#Task").prepend(html); // Prepend to show newest first
                            }
                            if (change.type === "modified") {
                                $(`li[data-key='${id}']`).replaceWith(html);
                            }
                            if (change.type === "removed") {
                                $(`li[data-key='${id}']`).remove();
                            }
                        });
                    }, (error) => {
                        console.error("Error listening to tasks:", error);
                        // Provide more specific feedback if an error occurs
                        if (error.code === "permission-denied") {
                            // This might happen if Firestore rules are too restrictive
                            alert("Permission denied to access tasks. Please check Firestore security rules.");
                        } else {
                            alert("An error occurred while loading tasks: " + error.message);
                        }
                    });
            }

            // Function to render a task item in the UI
            function renderTask(id, todo, done, timestamp) {
                const formattedTime = new Date(timestamp.toDate()).toLocaleString();
                const taskClass = done ? 'line-through' : '';
                const buttonText = done ? 'Undone' : 'Done';
                const buttonClass = done ? 'button-undone hover:button-undone-hover' : 'button-done hover:button-done-hover';

                return `
                    <li class="task-item flex items-center justify-between p-4 border-b last:border-b-0 transition duration-200 ease-in-out transform hover:scale-[1.01]" data-key="${id}">
                        <div class="flex-1">
                            <span class="task-text text-lg font-medium ${taskClass}">${todo}</span>
                            <input type="text" value="${todo}" class="task-edit-input flex-1 px-3 py-2 border rounded-md input-field hidden">
                            <p class="timestamp-text text-xs mt-1">${formattedTime}</p>
                        </div>
                        <div class="task-buttons flex space-x-2 ml-4">
                            <button class="task-toggle-button px-4 py-2 rounded-md text-sm font-semibold transition duration-200 ease-in-out ${buttonClass}">${buttonText}</button>
                            <button class="task-edit-button px-4 py-2 rounded-md text-sm font-semibold transition duration-200 ease-in-out button-edit hover:button-edit-hover">Edit</button>
                            <button class="task-delete-button px-4 py-2 rounded-md text-sm font-semibold transition duration-200 ease-in-out button-delete hover:button-delete-hover">Delete</button>
                            <button class="task-save-button px-4 py-2 rounded-md text-sm font-semibold transition duration-200 ease-in-out button-save hover:button-save-hover hidden">Save</button>
                            <button class="task-cancel-button px-4 py-2 rounded-md text-sm font-semibold transition duration-200 ease-in-out button-cancel hover:button-cancel-hover hidden">Cancel</button>
                        </div>
                    </li>
                `;
            }

            // Add Task
            $('.new-task-form').on('submit', function(e) {
                e.preventDefault();
                if (!currentUser) {
                    alert('Please log in to add tasks.');
                    return;
                }
                const newTaskInput = $('.new-task');
                const taskText = newTaskInput.val().trim();

                if (taskText) {
                    db.collection("Task").add({
                            userId: currentUser.uid, // Store user ID with the task
                            todo: taskText,
                            done: false,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        })
                        .then(() => {
                            newTaskInput.val(''); // Clear input
                        })
                        .catch((error) => {
                            console.error("Error adding document: ", error);
                            alert("Failed to add task: " + error.message);
                        });
                }
            });

            // Handle Clicks on Task Buttons (Delegated Events)
            $('#Task').on('click', '.task-toggle-button', function() {
                if (!currentUser) {
                    alert('Please log in to modify tasks.');
                    return;
                }
                const listItem = $(this).closest('li');
                const id = listItem.data('key');
                const isDone = listItem.find('.task-text').hasClass('line-through');

                db.collection("Task").doc(id).update({
                        done: !isDone
                    })
                    .catch((error) => {
                        console.error("Error updating document: ", error);
                        alert("Failed to update task status: " + error.message);
                    });
            });

            $('#Task').on('click', '.task-delete-button', function() {
                if (!currentUser) {
                    alert('Please log in to delete tasks.');
                    return;
                }
                if (confirm('Are you sure you want to delete this task?')) {
                    const listItem = $(this).closest('li');
                    const id = listItem.data('key');

                    db.collection("Task").doc(id).delete()
                        .catch((error) => {
                            console.error("Error removing document: ", error);
                            alert("Failed to delete task: " + error.message);
                        });
                }
            });

            $('#Task').on('click', '.task-edit-button', function() {
                const listItem = $(this).closest('li');
                const taskTextSpan = listItem.find('.task-text');
                const taskEditInput = listItem.find('.task-edit-input');
                const editButton = $(this);
                const toggleButton = listItem.find('.task-toggle-button');
                const deleteButton = listItem.find('.task-delete-button');
                const saveButton = listItem.find('.task-save-button'); // Correctly target save button
                const cancelButton = listItem.find('.task-cancel-button');

                // Hide text, show input
                taskTextSpan.addClass('hidden');
                taskEditInput.removeClass('hidden');

                // Set focus and put cursor at the end
                const tempVal = taskEditInput.val();
                taskEditInput.val('');
                taskEditInput.val(tempVal);
                taskEditInput.focus();

                // Hide edit/toggle/delete, show save/cancel
                editButton.addClass('hidden');
                toggleButton.addClass('hidden');
                deleteButton.addClass('hidden');
                saveButton.removeClass('hidden');
                cancelButton.removeClass('hidden');
            });

            $('#Task').on('click', '.task-save-button', function() {
                if (!currentUser) {
                    alert('Please log in to save changes.');
                    return;
                }
                const listItem = $(this).closest('li');
                const id = listItem.data('key');
                const taskEditInput = listItem.find('.task-edit-input');
                const newText = taskEditInput.val().trim();

                if (newText) {
                    db.collection("Task").doc(id).update({
                            todo: newText
                        })
                        .then(() => {
                            // UI update handled by onSnapshot listener
                            // After saving, revert buttons to original state
                            const taskTextSpan = listItem.find('.task-text');
                            const editButton = listItem.find('.task-edit-button');
                            const toggleButton = listItem.find('.task-toggle-button');
                            const deleteButton = listItem.find('.task-delete-button');
                            const saveButton = listItem.find('.task-save-button');
                            const cancelButton = listItem.find('.task-cancel-button');

                            taskTextSpan.removeClass('hidden');
                            taskEditInput.addClass('hidden');
                            
                            editButton.removeClass('hidden');
                            toggleButton.removeClass('hidden');
                            deleteButton.removeClass('hidden');
                            saveButton.addClass('hidden');
                            cancelButton.addClass('hidden');
                        })
                        .catch((error) => {
                            console.error("Error updating document: ", error);
                            alert("Failed to save task: " + error.message);
                        });
                } else {
                    alert('Task cannot be empty!');
                }
            });

            $('#Task').on('click', '.task-cancel-button', function() {
                const listItem = $(this).closest('li');
                const taskTextSpan = listItem.find('.task-text');
                const taskEditInput = listItem.find('.task-edit-input');
                const editButton = listItem.find('.task-edit-button');
                const toggleButton = listItem.find('.task-toggle-button');
                const deleteButton = listItem.find('.task-delete-button');
                const saveButton = listItem.find('.task-save-button'); // FIXED: Correctly target save button
                const cancelButton = $(this); // Target the clicked cancel button itself

                // Show text, hide input
                taskTextSpan.removeClass('hidden');
                taskEditInput.addClass('hidden');

                // Show edit/toggle/delete, hide save/cancel
                editButton.removeClass('hidden');
                toggleButton.removeClass('hidden');
                deleteButton.removeClass('hidden');
                saveButton.addClass('hidden'); // Now this correctly hides the save button
                cancelButton.addClass('hidden'); // This hides the cancel button

                // Reset input value to original task text
                taskEditInput.val(taskTextSpan.text());
            });

            // Prevent form submission on enter in edit input, instead trigger save
            $('#Task').on('keypress', '.task-edit-input', function(e) {
                if (e.which === 13) { // Enter key
                    e.preventDefault();
                    $(this).closest('li').find('.task-save-button').click();
                }
            });

            // Initial state: hide task section and new task form until logged in
            taskSection.addClass('hidden');
            newTaskForm.addClass('hidden');
        });
    </script>
</body>
</html>
