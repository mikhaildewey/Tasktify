<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tasktify - Your Customizable To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: var(--font-family);
            background: var(--primary-bg); /* Use CSS variable for primary background */
            transition: background 0.5s ease; /* Smooth transition for background gradient */
        }

        /* Define CSS Variables on the root element */
        :root {
            /* Colors */
            --primary-bg: linear-gradient(to right, #8b5cf6, #4f46e5); /* purple-500 to indigo-600 */
            --secondary-bg: #ffffff; /* white */
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #6b7280; /* gray-500 */
            --header-text: #4338ca; /* indigo-700 */
            --input-border: #d1d5db; /* gray-300 */
            --input-focus-ring: #a5b4fc; /* indigo-300 */
            --button-primary-bg: #4f46e5; /* indigo-600 */
            --button-primary-hover-bg: #4338ca; /* indigo-700 */
            --task-item-bg: #ffffff; /* white */
            --task-item-border: #e5e7eb; /* gray-200 */
            --task-text-done: #9ca3af; /* gray-400 */ /* For line-through */
            --timestamp-text: #9ca3af; /* gray-400 */
            --button-done-bg: #22c55e; /* green-500 */
            --button-done-hover-bg: #16a34a; /* green-600 */
            --button-undone-bg: #f59e0b; /* yellow-500 */
            --button-undone-hover-bg: #d97706; /* yellow-600 */
            --button-edit-bg: #3b82f6; /* blue-500 */
            --button-edit-hover-bg: #2563eb; /* blue-600 */
            --button-delete-bg: #ef4444; /* red-500 */
            --button-delete-hover-bg: #dc2626; /* red-600 */
            --button-save-bg: #2563eb;
            --button-save-hover-bg: #1d4ed8;
            --button-cancel-bg: #9ca3af;
            --button-cancel-hover-bg: #6b7280;
            --error-text-color: #ef4444;
            --google-button-bg: #db4437;
            --google-button-hover-bg: #c13122;
        }

        /* Apply variables to Tailwind classes */
        .main-container {
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius-main);
            box-shadow: var(--shadow-main);
            color: var(--text-primary);
        }
        .header-text {
            color: var(--header-text);
        }
        .input-field {
            border-color: var(--input-border);
            color: var(--text-primary);
            background-color: var(--secondary-bg);
        }
        .input-field::placeholder {
            color: var(--text-secondary);
        }
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 4px var(--input-focus-ring);
        }
        .button-primary {
            background-color: var(--button-primary-bg);
            color: white;
        }
        .button-primary:hover {
            background-color: var(--button-primary-hover-bg);
        }
        .button-google {
            background-color: var(--google-button-bg);
            color: white;
        }
        .button-google:hover {
            background-color: var(--google-button-hover-bg);
        }
        .task-item {
            background-color: var(--task-item-bg);
            border-color: var(--task-item-border);
            box-shadow: var(--shadow-item);
            border-radius: var(--border-radius-elements);
        }
        .task-text {
            color: var(--text-primary);
        }
        .task-text.line-through {
            color: var(--task-text-done);
        }
        .timestamp-text {
            color: var(--timestamp-text);
        }
        .button-done {
            background-color: var(--button-done-bg);
            color: white;
        }
        .button-done:hover {
            background-color: var(--button-done-hover-bg);
        }
        .button-undone {
            background-color: var(--button-undone-bg);
            color: white;
        }
        .button-undone:hover {
            background-color: var(--button-undone-hover-bg);
        }
        .button-edit {
            background-color: var(--button-edit-bg);
            color: white;
        }
        .button-edit:hover {
            background-color: var(--button-edit-hover-bg);
        }
        .button-delete {
            background-color: var(--button-delete-bg);
            color: white;
        }
        .button-delete:hover {
            background-color: var(--button-delete-hover-bg);
        }
        .button-save {
            background-color: var(--button-save-bg);
            color: white;
        }
        .button-save:hover {
            background-color: var(--button-save-hover-bg);
        }
        .button-cancel {
            background-color: var(--button-cancel-bg);
            color: white;
        }
        .button-cancel:hover {
            background-color: var(--button-cancel-hover-bg);
        }
        .theme-selector-wrapper .theme-selector {
            background-color: var(--task-item-bg);
            color: var(--text-primary);
        }
        .theme-selector-wrapper .theme-selector:focus {
             outline: none;
            box-shadow: 0 0 0 2px var(--input-focus-ring);
        }
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .header-content h1 {
            text-align: center;
            max-width: fit-content;
            margin-left: 0;
            margin-right: 0;
        }
        .header-content > .flex.items-center.justify-between.w-full {
            margin-top: 0.5rem;
        }

        .auth-error {
            color: var(--error-text-color);
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
        .user-info {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            font-size: 0.875rem;
            color: var(--text-primary);
            background-color: var(--secondary-bg);
            border-radius: var(--border-radius-elements);
            box-shadow: var(--shadow-item);
            margin-bottom: 1rem;
        }
        .user-info button {
            background-color: var(--button-cancel-bg);
            color: white;
            padding: 4px 8px;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .user-info button:hover {
            background-color: var(--button-cancel-hover-bg);
        }
        .button-google img {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6">

    <div class="w-full max-w-lg main-container rounded-2xl shadow-xl p-8 transform transition-all duration-300 hover:scale-105 relative">
        <div class="header-content flex flex-col items-center mb-6 relative">
            <div id="user-display" class="user-info w-full flex justify-between items-center mb-4 hidden">
                <span id="user-email" class="text-sm font-medium"></span>
                <button id="logout-button" class="px-3 py-1 text-xs rounded-md transition button-cancel hover:button-cancel-hover">Logout</button>
            </div>
            
            <div class="flex items-center justify-between w-full">
                <h1 class="text-4xl font-extrabold header-text tracking-tight flex-grow text-center">Tasktify</h1>
                <div class="flex items-center gap-2 theme-selector-wrapper">
                    <label for="theme-selector" class="text-sm theme-selector-label" style="color: var(--text-primary);">Theme:</label>
                    <select id="theme-selector" class="p-2 rounded-md theme-selector focus:ring-2 focus:ring-indigo-400">
                        <option value="default">Default (Light)</option>
                        <option value="dark">Dark Mode</option>
                        <option value="ocean">Ocean Blue</option>
                        <option value="forest">Forest Green</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="auth-section" class="mb-6">
            <h2 class="text-2xl font-semibold mb-4 text-center header-text">Welcome!</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium" style="color: var(--text-primary);">Email</label>
                    <input type="email" id="login-email" required class="input-field mt-1 block w-full px-4 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium" style="color: var(--text-primary);">Password</label>
                    <input type="password" id="login-password" required class="input-field mt-1 block w-full px-4 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="button-primary w-full px-4 py-2 rounded-md transition duration-300 ease-in-out">
                    Login
                </button>
                <p id="login-error" class="auth-error text-center"></p>
                <p class="text-center my-4" style="color: var(--text-secondary);">OR</p>
                <button type="button" id="google-login-button" class="button-google w-full px-4 py-2 rounded-md transition duration-300 ease-in-out flex items-center justify-center">
                    <img src="https://img.icons8.com/color/48/000000/google-logo.png" alt="Google Logo" />
                    Login with Google
                </button>
                <p class="text-center text-sm mt-4" style="color: var(--text-secondary);">
                    Don't have an account? <a href="#" id="show-signup" class="text-indigo-600 hover:text-indigo-800 font-medium">Sign Up</a>
                </p>
            </form>

            <form id="signup-form" class="space-y-4 hidden">
                <div>
                    <label for="signup-email" class="block text-sm font-medium" style="color: var(--text-primary);">Email</label>
                    <input type="email" id="signup-email" required class="input-field mt-1 block w-full px-4 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium" style="color: var(--text-primary);">Password</label>
                    <input type="password" id="signup-password" required class="input-field mt-1 block w-full px-4 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="button-primary w-full px-4 py-2 rounded-md transition duration-300 ease-in-out">
                    Sign Up
                </button>
                <p id="signup-error" class="auth-error text-center"></p>
                <p class="text-center my-4" style="color: var(--text-secondary);">OR</p>
                 <button type="button" id="google-signup-button" class="button-google w-full px-4 py-2 rounded-md transition duration-300 ease-in-out flex items-center justify-center">
                    <img src="https://img.icons8.com/color/48/000000/google-logo.png" alt="Google Logo" />
                    Sign Up with Google
                </button>
                <p class="text-center text-sm mt-4" style="color: var(--text-secondary);">
                    Already have an account? <a href="#" id="show-login" class="text-indigo-600 hover:text-indigo-800 font-medium">Login</a>
                </p>
            </form>
        </div>

        <div id="task-section" class="hidden">
            <form class="new-task-form flex gap-3 mb-6">
                <input
                    type="text"
                    required
                    class="new-task flex-1 px-5 py-3 border rounded-xl text-lg placeholder-gray-400 input-field"
                    placeholder="What's your next task?" />
                <button
                    type="submit"
                    class="button-primary px-6 py-3 rounded-xl hover:bg-indigo-700 transition duration-300 ease-in-out shadow-lg text-lg">
                    Add Task
                </button>
            </form>
            <ol id="Task" class="space-y-4"></ol>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Firebase Configuration
            // IMPORTANT: Replace with your actual Firebase project configuration!
            const firebaseConfig = {
                apiKey: "AIzaSyDONsCD2ylgOMLz2gmZ0dEz2C4IdeF0wKA", // REPLACE THIS LINE WITH YOUR ACTUAL API KEY
                authDomain: "tasktify-1cb16.firebaseapp.com", // REPLACE THIS LINE WITH YOUR ACTUAL AUTH DOMAIN
                projectId: "tasktify-1cb16", // REPLACE THIS LINE WITH YOUR ACTUAL PROJECT ID
                storageBucket: "tasktify-1cb16.appspot.com", // REPLACE THIS LINE WITH YOUR ACTUAL STORAGE BUCKET
                messagingSenderId: "759089908374", // REPLACE THIS LINE WITH YOUR ACTUAL MESSAGING SENDER ID
                appId: "1:759089908374:web:cf8a405e6ceb129b6090b7", // REPLACE THIS LINE WITH YOUR ACTUAL APP ID
                measurementId: "G-50NJYVKLB7" // REPLACE THIS LINE WITH YOUR ACTUAL MEASUREMENT ID (OR REMOVE IF NOT APPLICABLE)
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            const googleProvider = new firebase.auth.GoogleAuthProvider(); // Initialize Google Auth Provider

            let currentUser = null; // To store the current authenticated user

            // --- Theme Switching Logic ---
            const themeSelector = $('#theme-selector');
            const root = document.documentElement; // Get the :root element

            const themes = {
                'default': { // Light Theme (similar to current)
                    '--primary-bg': 'linear-gradient(to right, #8b5cf6, #4f46e5)',
                    '--secondary-bg': '#ffffff',
                    '--text-primary': '#1f2937',
                    '--text-secondary': '#6b7280',
                    '--header-text': '#4338ca',
                    '--input-border': '#d1d5db',
                    '--input-focus-ring': '#a5b4fc',
                    '--button-primary-bg': '#4f46e5',
                    '--button-primary-hover-bg': '#4338ca',
                    '--task-item-bg': '#ffffff',
                    '--task-item-border': '#e5e7eb',
                    '--task-text-done': '#9ca3af',
                    '--timestamp-text': '#9ca3af',
                    '--button-done-bg': '#22c55e',
                    '--button-done-hover-bg': '#16a34a',
                    '--button-undone-bg': '#f59e0b',
                    '--button-undone-hover-bg': '#d97706',
                    '--button-edit-bg': '#3b82f6',
                    '--button-edit-hover-bg': '#2563eb',
                    '--button-delete-bg': '#ef4444',
                    '--button-delete-hover-bg': '#dc2626',
                    '--button-save-bg': '#2563eb',
                    '--button-save-hover-bg': '#1d4ed8',
                    '--button-cancel-bg': '#9ca3af',
                    '--button-cancel-hover-bg': '#6b7280',
                    '--error-text-color': '#ef4444',
                    '--google-button-bg': '#db4437',
                    '--google-button-hover-bg': '#c13122',
                },
                'dark': {
                    '--primary-bg': '#1a202c', /* charcoal */
                    '--secondary-bg': '#2d3748', /* darker gray */
                    '--text-primary': '#e2e8f0', /* light gray */
                    '--text-secondary': '#a0aec0', /* lighter gray */
                    '--header-text': '#9f7aea', /* lighter purple */
                    '--input-border': '#4a5568',
                    '--input-focus-ring': '#6b46c1', /* darker purple */
                    '--button-primary-bg': '#6b46c1',
                    '--button-primary-hover-bg': '#553c9a',
                    '--task-item-bg': '#2d3748',
                    '--task-item-border': '#4a5568',
                    '--task-text-done': '#a0aec0',
                    '--timestamp-text': '#a0aec0',
                    '--button-done-bg': '#38a169', /* darker green */
                    '--button-done-hover-bg': '#2f855a',
                    '--button-undone-bg': '#d69e2e', /* darker yellow */
                    '--button-undone-hover-bg': '#b7791f',
                    '--button-edit-bg': '#4299e1', /* darker blue */
                    '--button-edit-hover-bg': '#3182ce',
                    '--button-delete-bg': '#e53e3e', /* darker red */
                    '--button-delete-hover-bg': '#c53030',
                    '--button-save-bg': '#3182ce',
                    '--button-save-hover-bg': '#2b6cb0',
                    '--button-cancel-bg': '#4a5568',
                    '--button-cancel-hover-bg': '#2d3748',
                    '--error-text-color': '#fc8181', /* Lighter red for dark mode */
                    '--google-button-bg': '#db4437',
                    '--google-button-hover-bg': '#c13122',
                },
                'ocean': {
                    '--primary-bg': 'linear-gradient(to right, #6366f1, #3b82f6)', /* indigo-500 to blue-500 */
                    '--secondary-bg': '#e0f2fe', /* light blue */
                    '--text-primary': '#1e3a8a', /* dark blue */
                    '--text-secondary': '#4a679e',
                    '--header-text': '#1e3a8a',
                    '--input-border': '#93c5fd', /* blue-300 */
                    '--input-focus-ring': '#a5b4fc',
                    '--button-primary-bg': '#2563eb', /* blue-600 */
                    '--button-primary-hover-bg': '#1e40af', /* blue-800 */
                    '--task-item-bg': '#eff6ff', /* lighter blue */
                    '--task-item-border': '#bfdbfe', /* blue-200 */
                    '--task-text-done': '#60a5fa', /* blue-400 */
                    '--timestamp-text': '#60a5fa',
                    '--button-done-bg': '#34d399', /* teal */
                    '--button-done-hover-bg': '#10b981',
                    '--button-undone-bg': '#fbbf24', /* amber */
                    '--button-undone-hover-bg': '#f59e0b',
                    '--button-edit-bg': '#3b82f6',
                    '--button-edit-hover-bg': '#2563eb',
                    '--button-delete-bg': '#ef4444',
                    '--button-delete-hover-bg': '#dc2626',
                    '--button-save-bg': '#2563eb',
                    '--button-save-hover-bg': '#1d4ed8',
                    '--button-cancel-bg': '#93c5fd',
                    '--button-cancel-hover-bg': '#60a5fa',
                    '--error-text-color': '#e0f2fe',
                    '--google-button-bg': '#db4437',
                    '--google-button-hover-bg': '#c13122',
                },
                'forest': {
                    '--primary-bg': 'linear-gradient(to right, #10b981, #059669)', /* emerald-500 to green-600 */
                    '--secondary-bg': '#f0fdf4', /* light green */
                    '--text-primary': '#1f2937', /* dark gray */
                    '--text-secondary': '#4b5563', /* gray */
                    '--header-text': '#047857', /* dark green */
                    '--input-border': '#a7f3d0', /* emerald-200 */
                    '--input-focus-ring': '#6ee7b7', /* emerald-300 */
                    '--button-primary-bg': '#059669', /* green-600 */
                    '--button-primary-hover-bg': '#047857', /* green-700 */
                    '--task-item-bg': '#d1fae5', /* very light green */
                    '--task-item-border': '#6ee7b7', /* emerald-300 */
                    '--task-text-done': '#34d399', /* emerald-500 */
                    '--timestamp-text': '#34d399',
                    '--button-done-bg': '#22c55e',
                    '--button-done-hover-bg': '#16a34a',
                    '--button-undone-bg': '#fbbf24',
                    '--button-undone-hover-bg': '#f59e0b',
                    '--button-edit-bg': '#4ade80', /* lime-400 */
                    '--button-edit-hover-bg': '#22c55e',
                    '--button-delete-bg': '#ef4444',
                    '--button-delete-hover-bg': '#dc2626',
                    '--button-save-bg': '#059669',
                    '--button-save-hover-bg': '#047857',
                    '--button-cancel-bg': '#a7f3d0',
                    '--button-cancel-hover-bg': '#6ee7b7',
                    '--error-text-color': '#f87171',
                    '--google-button-bg': '#db4437',
                    '--google-button-hover-bg': '#c13122',
                }
            };

            function applyTheme(themeName) {
                const selectedTheme = themes[themeName];
                for (const property in selectedTheme) {
                    root.style.setProperty(property, selectedTheme[property]);
                }
                localStorage.setItem('chosenTheme', themeName);
            }

            // Load saved theme or set default on page load
            const savedTheme = localStorage.getItem('chosenTheme');
            if (savedTheme && themes[savedTheme]) {
                applyTheme(savedTheme);
                themeSelector.val(savedTheme); // Set dropdown to current theme
            } else {
                applyTheme('default'); // Fallback to default theme
                themeSelector.val('default');
            }

            // Event listener for theme selector
            themeSelector.on('change', function() {
                applyTheme($(this).val());
            });

            // --- End Theme Switching Logic ---

            // --- Auth Logic ---
            const authSection = $('#auth-section');
            const taskSection = $('#task-section');
            const loginForm = $('#login-form');
            const signupForm = $('#signup-form');
            const loginError = $('#login-error');
            const signupError = $('#signup-error');
            const showSignup = $('#show-signup');
            const showLogin = $('#show-login');
            const userDisplay = $('#user-display');
            const userEmailSpan = $('#user-email');
            const logoutButton = $('#logout-button');
            const googleLoginButton = $('#google-login-button'); // New Google button
            const googleSignupButton = $('#google-signup-button'); // New Google button

            // Toggle between login and signup forms
            showSignup.on('click', function(e) {
                e.preventDefault();
                loginForm.hide();
                signupForm.show();
                loginError.text('');
                signupError.text('');
            });

            showLogin.on('click', function(e) {
                e.preventDefault();
                signupForm.hide();
                loginForm.show();
                loginError.text('');
                signupError.text('');
            });

            // Login Handler (Email/Password)
            loginForm.on('submit', function(e) {
                e.preventDefault();
                const email = $('#login-email').val();
                const password = $('#login-password').val();
                loginError.text('');

                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Signed in - handled by onAuthStateChanged listener
                    })
                    .catch((error) => {
                        const errorMessage = error.message;
                        loginError.text(errorMessage);
                    });
            });

            // Signup Handler (Email/Password)
            signupForm.on('submit', function(e) {
                e.preventDefault();
                const email = $('#signup-email').val();
                const password = $('#signup-password').val();
                signupError.text('');

                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Signed up - handled by onAuthStateChanged listener
                    })
                    .catch((error) => {
                        const errorMessage = error.message;
                        signupError.text(errorMessage);
                    });
            });

            // Google Sign-In Handler
            function handleGoogleSignIn() {
                auth.signInWithPopup(googleProvider)
                    .then((result) => {
                        // Handled by onAuthStateChanged listener
                    }).catch((error) => {
                        const errorMessage = error.message;
                        if (loginForm.is(':visible')) {
                            loginError.text(`Google Sign-in Error: ${errorMessage}`);
                        } else if (signupForm.is(':visible')) {
                            signupError.text(`Google Sign-up Error: ${errorMessage}`);
                        }
                        console.error("Google Sign-in Error:", error);
                    });
            }

            googleLoginButton.on('click', handleGoogleSignIn);
            googleSignupButton.on('click', handleGoogleSignIn);

            // Logout Handler
            logoutButton.on('click', function() {
                auth.signOut().then(() => {
                    // Signed out - handled by onAuthStateChanged listener
                }).catch((error) => {
                    console.error("Logout Error:", error);
                });
            });

            // Firebase Auth State Listener
            auth.onAuthStateChanged((user) => {
                currentUser = user; // Update the global currentUser variable
                if (user) {
                    // User is logged in
                    authSection.hide();
                    taskSection.show();
                    userDisplay.removeClass('hidden');
                    userEmailSpan.text(user.email);
                    $("#Task").empty(); // Clear previous tasks on login
                    setupRealtimeListener(user.uid); // Setup listener for this user's tasks
                } else {
                    // User is logged out
                    authSection.show();
                    taskSection.hide();
                    userDisplay.addClass('hidden');
                    userEmailSpan.text('');
                    $("#Task").empty(); // Clear tasks on logout
                    if (taskListener) { // Unsubscribe if a listener exists
                        taskListener();
                        taskListener = null;
                    }
                    // Show login form by default on logout
                    loginForm.show();
                    signupForm.hide();
                    loginError.text('');
                    signupError.text('');
                }
            });

            // --- End Auth Logic ---

            // --- Firestore Task Logic (Modified for User Specificity) ---
            let taskListener = null; // To store the Firestore listener unsubscribe function

            function setupRealtimeListener(uid) {
                // If a listener already exists, unsubscribe it first
                if (taskListener) {
                    taskListener();
                }

                // Setup new listener for the current user's tasks
                // This is the query that filters by userId and orders by timestamp
                taskListener = db.collection("Task")
                    .where("userId", "==", uid) // Filter by current user's ID
                    .orderBy("timestamp", "desc") // Order by timestamp
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            const data = change.doc.data();
                            const id = change.doc.id;
                            const html = renderTask(id, data.todo, data.done, data.timestamp);

                            if (change.type === "added") {
                                $("#Task").prepend(html); // Prepend to show newest first
                            }
                            if (change.type === "modified") {
                                $(`li[data-key='${id}']`).replaceWith(html);
                            }
                            if (change.type === "removed") {
                                $(`li[data-key='${id}']`).remove();
                            }
                        });
                    }, (error) => {
                        console.error("Error listening to tasks:", error);
                        // Provide more specific feedback if an error occurs
                        if (error.code === "permission-denied") {
                            alert("You do not have permission to view these tasks. Please ensure you are logged in and your Firestore rules are correct.");
                        } else if (error.code === "failed-precondition" && error.message.includes("The query requires an index")) {
                            // This specific check might not always catch it if the error message changes slightly
                            alert("Firestore Indexing Error: A required database index is missing or still building. Please check the Firebase console > Firestore Database > Indexes tab for the 'Task' collection on 'userId' and 'timestamp'.");
                        }
                        else {
                            alert("An unexpected error occurred while fetching tasks: " + error.message);
                        }
                    });
            }

            // Function to render a task
            function renderTask(id, todo, done, timestamp) {
                const date = timestamp ? new Date(timestamp.toDate()).toLocaleString() : 'No date';
                const taskHTML = `
                    <li data-key="${id}" class="task-item flex flex-col sm:flex-row justify-between items-start sm:items-center px-6 py-4 border border-gray-200 rounded-xl transition-all duration-200 ease-in-out hover:shadow-lg">
                        <div class="flex-1 mb-2 sm:mb-0 mr-0 sm:mr-4">
                            <span class="task-text ${done ? 'line-through' : 'font-semibold text-lg'}">${todo}</span>
                            <p class="text-sm mt-1 timestamp-text">Created: ${date}</p>
                        </div>
                        <div class="flex flex-wrap gap-2 justify-end">
                            ${done ?
                                `<button doc-id="${id}" class="undone-task px-4 py-2 rounded-lg transition text-sm button-undone">Undone</button>` :
                                `<button doc-id="${id}" class="done-task px-4 py-2 rounded-lg transition text-sm button-done">Done</button>`
                            }
                            <button doc-id="${id}" class="edit-task px-4 py-2 rounded-lg transition text-sm button-edit">Edit</button>
                            <button doc-id="${id}" class="delete-task px-4 py-2 rounded-lg transition text-sm button-delete">Delete</button>
                        </div>
                    </li>`;
                return taskHTML;
            }

            // Add new task
            $(".new-task-form").submit(function (e) {
                e.preventDefault();
                const newTask = $(".new-task").val().trim();
                if (newTask && currentUser) { // Ensure user is logged in
                    db.collection("Task").add({
                        todo: newTask,
                        done: false,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: currentUser.uid // Store the user ID with the task
                    }).then(() => {
                        console.log("Task added successfully!");
                        $(".new-task").val(""); // Clear input on success
                    }).catch((error) => {
                        console.error("Error adding task: ", error);
                        alert("Failed to add task: " + error.message);
                    });
                } else if (!currentUser) {
                    alert("Please log in to add tasks.");
                }
            });

            // Mark task as done
            $(document).on('click', '.done-task', function () {
                const id = $(this).attr("doc-id");
                if (currentUser) {
                    db.collection("Task").doc(id).update({ done: true }).catch(error => {
                        console.error("Error marking task done: ", error);
                        alert("Failed to update task: " + error.message);
                    });
                }
            });

            // Mark task as undone
            $(document).on('click', '.undone-task', function () {
                const id = $(this).attr("doc-id");
                if (currentUser) {
                    db.collection("Task").doc(id).update({ done: false }).catch(error => {
                        console.error("Error marking task undone: ", error);
                        alert("Failed to update task: " + error.message);
                    });
                }
            });

            // Edit task
            $(document).on('click', '.edit-task', function () {
                const listItem = $(this).closest('.task-item');
                const id = listItem.data('key');
                const currentTextElement = listItem.find('.task-text');
                const currentText = currentTextElement.text();

                // Replace text with input field, apply input-field classes
                currentTextElement.replaceWith(`
                    <input type="text" class="edit-input flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 input-field" value="${currentText}" />
                `);

                // Change buttons to Save and Cancel, apply respective button classes
                listItem.find('.flex-wrap').html(`
                    <button doc-id="${id}" class="save-edit px-4 py-2 rounded-lg transition text-sm button-save">Save</button>
                    <button doc-id="${id}" class="cancel-edit px-4 py-2 rounded-lg transition text-sm button-cancel">Cancel</button>
                `);
            });

            // Save edited task
            $(document).on('click', '.save-edit', function () {
                const listItem = $(this).closest('.task-item');
                const id = $(this).attr("doc-id");
                const newText = listItem.find('.edit-input').val().trim();

                if (newText && currentUser) {
                    db.collection("Task").doc(id).update({ todo: newText }).catch(error => {
                        console.error("Error saving task edit: ", error);
                        alert("Failed to save task: " + error.message);
                    });
                }
                // The Firestore snapshot listener will handle re-rendering once the update is successful.
            });

            // Cancel edit
            $(document).on('click', '.cancel-edit', async function () {
                const listItem = $(this).closest('.task-item');
                const id = $(this).attr("doc-id");

                if (currentUser) {
                    try {
                        const doc = await db.collection("Task").doc(id).get();
                        if (doc.exists) {
                            const data = doc.data();
                            const html = renderTask(id, data.todo, data.done, data.timestamp);
                            listItem.replaceWith(html); // Revert the UI to original state
                        }
                    } catch (error) {
                        console.error("Error fetching document to cancel edit:", error);
                        alert("Could not revert task due to an error: " + error.message);
                    }
                }
            });

            // Delete task
            $(document).on('click', '.delete-task', function () {
                const id = $(this).attr("doc-id");
                if (currentUser) {
                    db.collection("Task").doc(id).delete().catch(error => {
                        console.error("Error deleting task: ", error);
                        alert("Failed to delete task: " + error.message);
                    });
                }
            });
        });
    </script>
</body>
</html>
